rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Match any file in the `users` folder.
    // The {userId} wildcard captures the user's unique ID from the file path.
    match /users/{userId}/{allPaths=**} {
      
      // Allow read access only to authenticated users who are requesting a file
      // from their own folder. This prevents one user from seeing another user's files.
      allow read: if request.auth != null && request.auth.uid == userId;

      // Allow write access (uploads, updates, deletes) only to authenticated users
      // who are writing to their own folder. This also checks to make sure the user
      // is not trying to upload a massive file, which can protect you from abuse.
      allow write: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.size < 5 * 1024 * 1024; // 5 MB limit
    }
  }
}
